-- ROBLOX GUI & Auto Script Tổng Hợp
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local UserInputService = game:GetService("UserInputService")

local repairing = false
local espEnabled = false
local espLoop

-- Lấy character survivor
local function GetMyCharacter()
    local playersFolder = workspace:FindFirstChild("Players")
    if not playersFolder then return nil end
    local survivors = playersFolder:FindFirstChild("Survivors")
    if not survivors then return nil end
    for _, char in ipairs(survivors:GetChildren()) do
        if char:GetAttribute("Username") == LocalPlayer.Name then
            return char
        end
    end
    return nil
end

-- Repair Generator lung tung
local function RepairGenerator(gen)
    local currentCharacter = GetMyCharacter()
    if not currentCharacter then return end
    if not gen or not gen:FindFirstChild("Progress") or gen.Progress.Value >= 100 then
        return
    end
    local prompt = gen:FindFirstChild("Main") and gen.Main:FindFirstChild("Prompt")
    local remote = gen:FindFirstChild("Remotes") and gen.Remotes:FindFirstChild("RE")
    if not prompt or not remote then return end

    prompt.HoldDuration = 0
    prompt.RequiresLineOfSight = false
    prompt.MaxActivationDistance = 999999

    prompt:InputHoldBegin()
    prompt:InputHoldEnd()
    remote:FireServer()
end

-- AutoRepair lung tung, 3 giây giữa mỗi lần
local function AutoRepair()
    while repairing do
        task.wait()
        local character = GetMyCharacter()
        if character then
            local map = workspace:WaitForChild("Map"):WaitForChild("Ingame"):WaitForChild("Map")
            for _, gen in ipairs(map:GetChildren()) do
                if gen.Name == "Generator" and gen.Progress.Value < 100 then
                    RepairGenerator(gen)
                    task.wait(2) -- 3 giây chờ giữa mỗi lần sửa
                end
            end
        else
            task.wait(1)
        end
    end
end

-- ESP
local function RunESP()
    if espLoop then return end
    espLoop = task.spawn(function()
        while true do
            task.wait(0.5)
            if espEnabled then
                -- Xóa ESP cũ
                for _, oldEsp in ipairs(workspace:GetDescendants()) do
                    if oldEsp:IsA("BoxHandleAdornment") and oldEsp.Name == "ESPHighlight" then
                        oldEsp:Destroy()
                    end
                end

                local playersFolder = workspace:FindFirstChild("Players")
                if playersFolder then
                    -- Survivor xanh lá
                    local survivors = playersFolder:FindFirstChild("Survivors")
                    if survivors then
                        for _, char in ipairs(survivors:GetChildren()) do
                            local root = char:FindFirstChild("HumanoidRootPart")
                            if root then
                                local box = Instance.new("BoxHandleAdornment")
                                box.Name = "ESPHighlight"
                                box.Adornee = root
                                box.AlwaysOnTop = true
                                box.ZIndex = 10
                                box.Size = Vector3.new(1,3,1)
                                box.Color = BrickColor.new("Bright green")
                                box.Transparency = 0.6
                                box.Parent = root
                            end
                        end
                    end
                    -- Killer đỏ
                    local killers = playersFolder:FindFirstChild("Killers")
                    if killers then
                        for _, char in ipairs(killers:GetChildren()) do
                            local root = char:FindFirstChild("HumanoidRootPart")
                            if root then
                                local box = Instance.new("BoxHandleAdornment")
                                box.Name = "ESPHighlight"
                                box.Adornee = root
                                box.AlwaysOnTop = true
                                box.ZIndex = 10
                                box.Size = Vector3.new(1,3,1)
                                box.Color = BrickColor.new("Bright red")
                                box.Transparency = 0.6
                                box.Parent = root
                            end
                        end
                    end
                end
                -- Generator vàng
                local map = workspace:FindFirstChild("Map")
                if map then
                    local ingameMap = map:FindFirstChild("Ingame") and map.Ingame:FindFirstChild("Map")
                    if ingameMap then
                        for _, gen in ipairs(ingameMap:GetChildren()) do
                            if gen.Name == "Generator" then
                                local mainPart = gen:FindFirstChild("Main") or gen:FindFirstChildWhichIsA("BasePart")
                                if mainPart then
                                    local box = Instance.new("BoxHandleAdornment")
                                    box.Name = "ESPHighlight"
                                    box.Adornee = mainPart
                                    box.AlwaysOnTop = true
                                    box.ZIndex = 10
                                    box.Size = Vector3.new(1.5,2,1.5)
                                    box.Color = BrickColor.new("Bright yellow")
                                    box.Transparency = 0.7
                                    box.Parent = mainPart
                                end
                            end
                        end
                    end
                end
            else
                -- Xóa ESP khi tắt
                for _, oldEsp in ipairs(workspace:GetDescendants()) do
                    if oldEsp:IsA("BoxHandleAdornment") and oldEsp.Name == "ESPHighlight" then
                        oldEsp:Destroy()
                    end
                end
            end
        end
    end)
end

-- GUI
local function CreateGUI()
    if LocalPlayer.PlayerGui:FindFirstChild("MinhHubGui") then
        LocalPlayer.PlayerGui.MinhHubGui:Destroy()
    end

    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "MinhHubGui"
    screenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")

    -- Khung chính bự hơn
    local mainFrame = Instance.new("Frame")
    mainFrame.Size = UDim2.new(0,250,0,280)
    mainFrame.Position = UDim2.new(0,100,0,100)
    mainFrame.BackgroundColor3 = Color3.fromRGB(20,20,20)
    mainFrame.BackgroundTransparency = 0.2
    mainFrame.BorderSizePixel = 0
    mainFrame.Parent = screenGui

    local dragBar = Instance.new("Frame")
    dragBar.Size = UDim2.new(1,0,0,30)
    dragBar.BackgroundColor3 = Color3.fromRGB(10,10,10)
    dragBar.BorderSizePixel = 0
    dragBar.Parent = mainFrame

    local titleLabel = Instance.new("TextLabel")
    titleLabel.Size = UDim2.new(1,0,1,0)
    titleLabel.BackgroundTransparency = 1
    titleLabel.Text = "Minh hub"
    titleLabel.TextColor3 = Color3.new(1,1,1)
    titleLabel.TextScaled = true
    titleLabel.Font = Enum.Font.GothamBold
    titleLabel.Parent = dragBar

    -- Nút Fix Generator
    local fixButton = Instance.new("TextButton")
    fixButton.Size = UDim2.new(0,220,0,40)
    fixButton.Position = UDim2.new(0,15,0,50)
    fixButton.Text = "Fix Generator"
    fixButton.TextScaled = true
    fixButton.BackgroundColor3 = Color3.fromRGB(60,60,60)
    fixButton.TextColor3 = Color3.new(1,1,1)
    fixButton.Parent = mainFrame
    fixButton.MouseButton1Click:Connect(function()
        repairing = true
        task.spawn(AutoRepair)
    end)

    -- Nút ESP
    local espButton = Instance.new("TextButton")
    espButton.Size = UDim2.new(0,220,0,40)
    espButton.Position = UDim2.new(0,15,0,100)
    espButton.Text = "ESP: OFF"
    espButton.TextScaled = true
    espButton.BackgroundColor3 = Color3.fromRGB(60,60,60)
    espButton.TextColor3 = Color3.new(1,1,1)
    espButton.Parent = mainFrame
    espButton.MouseButton1Click:Connect(function()
        espEnabled = not espEnabled
        espButton.Text = espEnabled and "ESP: ON" or "ESP: OFF"
        RunESP()
    end)

    -- Nút Auto Farm
    local autoFarmButton = Instance.new("TextButton")
    autoFarmButton.Size = UDim2.new(0,220,0,40)
    autoFarmButton.Position = UDim2.new(0,15,0,150)
    autoFarmButton.Text = "Auto Farm"
    autoFarmButton.TextScaled = true
    autoFarmButton.BackgroundColor3 = Color3.fromRGB(0,100,200)
    autoFarmButton.TextColor3 = Color3.new(1,1,1)
    autoFarmButton.Parent = mainFrame
    autoFarmButton.MouseButton1Click:Connect(function()
        pcall(function()
            loadstring(game:HttpGet("https://rscripts.net/raw/open-source-forsaken-auto-farm_1744598703848_PiToGzz6va.txt",true))()
        end)
    end)

    -- Nút Attack Script (link mới)
    local attackButton = Instance.new("TextButton")
    attackButton.Size = UDim2.new(0,220,0,40)
    attackButton.Position = UDim2.new(0,15,0,200)
    attackButton.Text = "Attack Script"
    attackButton.TextScaled = true
    attackButton.BackgroundColor3 = Color3.fromRGB(80,60,150)
    attackButton.TextColor3 = Color3.new(1,1,1)
    attackButton.Parent = mainFrame
    attackButton.MouseButton1Click:Connect(function()
        pcall(function()
            loadstring(game:HttpGet("https://raw.githubusercontent.com/Minh-code0807/Main-Minh-Hub-ROBLOX/refs/heads/main/Attack%20Fosaken%20Minh%20Hub",true))()
        end)
    end)

    -- Nút Close
    local closeButton = Instance.new("TextButton")
    closeButton.Size = UDim2.new(0,220,0,40)
    closeButton.Position = UDim2.new(0,15,0,250)
    closeButton.Text = "Close GUI"
    closeButton.TextScaled = true
    closeButton.BackgroundColor3 = Color3.fromRGB(150,0,0)
    closeButton.TextColor3 = Color3.new(1,1,1)
    closeButton.Parent = mainFrame
    closeButton.MouseButton1Click:Connect(function()
        screenGui:Destroy()
    end)

    -- Kéo GUI
    local dragging = false
    local dragInput, mousePos, framePos
    local function update(input)
        local delta = input.Position - mousePos
        mainFrame.Position = UDim2.new(framePos.X.Scale, framePos.X.Offset + delta.X,
                                       framePos.Y.Scale, framePos.Y.Offset + delta.Y)
    end
    dragBar.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            mousePos = input.Position
            framePos = mainFrame.Position
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)
    dragBar.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement then
            dragInput = input
        end
    end)
    UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging then
            update(input)
        end
    end)
end

-- Tạo GUI lần đầu
CreateGUI()

-- Respawn giữ GUI
LocalPlayer.CharacterAdded:Connect(function()
    task.wait(1)
    CreateGUI()
end)
